<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦çš®æ’¿è²¨å–®æ¸¬è©¦ v4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #1e293b;
            color: #f1f5f9;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #ef4444;
            margin-bottom: 20px;
        }

        .upload-box {
            background: #334155;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            cursor: pointer;
            border: 2px dashed #64748b;
        }

        .upload-box:hover {
            border-color: #ef4444;
        }

        input[type="file"] {
            display: none;
        }

        .results {
            background: #334155;
            padding: 30px;
            border-radius: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #475569;
        }

        th {
            background: #475569;
            font-weight: 600;
        }

        tr:hover {
            background: #2d3748;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #475569;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #ef4444;
        }

        .stat-label {
            color: #cbd5e1;
            margin-top: 5px;
        }

        pre {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¦ è¦çš® PDF æ’¿è²¨å–®æ¸¬è©¦ (v4 - ç²¾ç¢ºåº§æ¨™ç‰ˆ)</h1>

        <div class="upload-box" id="uploadBox">
            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“¤</div>
            <p style="font-size: 1.2em;">é»æ“Šæˆ–æ‹–æ”¾è¦çš® PDF æ’¿è²¨å–®</p>
            <p style="color: #cbd5e1; margin-top: 10px;">ä½¿ç”¨ç²¾ç¢º X åº§æ¨™ç¯„åœè§£æ</p>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>è§£æçµæœ</h2>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="productCount">0</div>
                    <div class="stat-label">å•†å“æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalQty">0</div>
                    <div class="stat-label">ç¸½æ•¸é‡</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>åºè™Ÿ</th>
                        <th>å•†å“åç¨±</th>
                        <th>è¦æ ¼</th>
                        <th>å‡ºè²¨æ•¸é‡</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>

            <h3 style="margin-top: 30px;">èª¿è©¦è³‡è¨Š</h3>
            <pre id="debug"></pre>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');

        uploadBox.addEventListener('click', () => fileInput.click());
        uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); uploadBox.style.borderColor = '#ef4444'; });
        uploadBox.addEventListener('dragleave', () => { uploadBox.style.borderColor = '#64748b'; });
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.style.borderColor = '#64748b';
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                // ç‚ºæ¯å€‹ PDF é é¢åˆ†åˆ¥è™•ç†
                const allProducts = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();

                    const pageItems = [];
                    textContent.items.forEach(item => {
                        pageItems.push({
                            text: item.str.trim(),
                            x: Math.round(item.transform[4]),
                            y: Math.round(item.transform[5])
                        });
                    });

                    console.log(`\nè™•ç† PDF ç¬¬ ${i} é ...`);
                    const products = parseShopeePDF(pageItems, i);
                    allProducts.push(...products);
                }

                displayResults(allProducts);

            } catch (error) {
                alert('è§£æå¤±æ•—ï¼š' + error.message);
            }
        }

        function parseShopeePDF(items, pageNum) {
            const rows = groupByY(items);

            // æ¬„ä½ç¯„åœï¼ˆæ¯å€‹ PDF é é¢éƒ½ç›¸åŒï¼‰
            const columnRanges = {
                seq: { min: 32, max: 59 },
                productName: { min: 166, max: 307 },
                spec: { min: 308, max: 396 },
                quantity: { min: 397, max: 520 }
            };

            console.log(`  ğŸ“Š PDFç¬¬${pageNum}é ï¼Œç¸½è¡Œæ•¸:`, rows.length);

            // æ‰¾æ¨™é¡Œè¡Œ
            let headerY = null;
            for (let row of rows) {
                const text = row.items.map(i => i.text).join(' ');
                if (text.includes('å•†å“åç¨±') && text.includes('å‡ºè²¨æ•¸é‡')) {
                    headerY = row.y;
                    console.log(`  âœ… æ‰¾åˆ°æ¨™é¡Œè¡Œï¼ŒYè»¸: ${headerY}`);
                    break;
                }
            }

            if (!headerY) {
                console.log(`  âš ï¸ PDFç¬¬${pageNum}é æœªæ‰¾åˆ°æ¨™é¡Œè¡Œ`);
                return [];
            }

            // è§£æå•†å“ - æ”¯æ´å¤šè¡Œå•†å“
            const products = [];
            let currentProduct = null;

            rows.forEach(row => {
                if (row.y >= headerY) return;

                // æª¢æŸ¥æ˜¯å¦æœ‰åºè™Ÿï¼ˆæ–°å•†å“é–‹å§‹ï¼‰
                let seqNum = null;
                row.items.forEach(item => {
                    const x = item.x;
                    const t = item.text.trim();
                    if (x >= columnRanges.seq.min && x <= columnRanges.seq.max) {
                        const num = parseInt(t);
                        if (!isNaN(num) && num > 0) {
                            seqNum = num;
                        }
                    }
                });

                // å¦‚æœæ‰¾åˆ°åºè™Ÿï¼Œä»£è¡¨æ–°å•†å“é–‹å§‹
                if (seqNum) {
                    // ä¿å­˜å‰ä¸€å€‹å•†å“
                    if (currentProduct) {
                        products.push(currentProduct);
                    }

                    // é–‹å§‹æ–°å•†å“
                    currentProduct = {
                        seq: seqNum,
                        name: [],
                        spec: [],
                        quantity: null
                    };
                }

                // æå–ç•¶å‰è¡Œçš„è³‡æ–™ï¼ˆåŠ å…¥ç•¶å‰å•†å“ï¼‰
                if (currentProduct) {
                    // æª¢æŸ¥é€™ä¸€è¡Œæ˜¯å¦åŒ…å«ã€Œåˆè¨ˆã€ï¼ˆç¸½è¨ˆè¡Œï¼‰
                    const rowText = row.items.map(i => i.text).join(' ');
                    if (rowText.includes('åˆè¨ˆ')) {
                        return; // è·³éåˆè¨ˆè¡Œï¼Œä¸åˆä½µåˆ°å•†å“ä¸­
                    }

                    row.items.forEach(item => {
                        const x = item.x;
                        const t = item.text.trim();

                        // å•†å“åç¨±
                        if (x >= columnRanges.productName.min && x <= columnRanges.productName.max) {
                            if (!t.match(/^\d+$/)) {
                                currentProduct.name.push(t);
                            }
                        }
                        // è¦æ ¼
                        else if (x >= columnRanges.spec.min && x <= columnRanges.spec.max) {
                            if (!t.match(/^\d+$/)) {
                                currentProduct.spec.push(t);
                            }
                        }
                        // å‡ºè²¨æ•¸é‡
                        else if (x >= columnRanges.quantity.min && x <= columnRanges.quantity.max) {
                            const num = parseInt(t);
                            if (!isNaN(num) && num > 0) {
                                currentProduct.quantity = num;
                            }
                        }
                    });
                }
            });

            // ä¿å­˜æœ€å¾Œä¸€å€‹å•†å“
            if (currentProduct) {
                products.push(currentProduct);
            }

            // æ ¼å¼åŒ–çµæœï¼ˆåªä¿ç•™æœ‰æœ‰æ•ˆåºè™Ÿçš„å•†å“ï¼‰
            const formattedProducts = products
                .filter(p => p.seq && p.seq > 0) // åªä¿ç•™æœ‰åºè™Ÿçš„å•†å“ï¼Œæ’é™¤ã€Œåˆè¨ˆã€ç­‰ç„¡åºè™Ÿçš„è¡Œ
                .map(p => ({
                    seq: p.seq,
                    name: p.name.join(' '),
                    spec: p.spec.join(' '),
                    quantity: p.quantity || 0
                }));

            console.log(`  âœ… PDFç¬¬${pageNum}é æå– ${formattedProducts.length} å€‹å•†å“`);
            return formattedProducts;
        }

        function groupByY(items, tolerance = 5) {
            const sorted = [...items].sort((a, b) => b.y - a.y);
            const groups = [];
            sorted.forEach(item => {
                let found = false;
                for (let g of groups) {
                    if (Math.abs(g.y - item.y) <= tolerance) {
                        g.items.push(item);
                        found = true;
                        break;
                    }
                }
                if (!found) groups.push({ y: item.y, items: [item] });
            });
            groups.forEach(g => g.items.sort((a, b) => a.x - b.x));
            return groups;
        }

        function displayResults(products) {
            document.getElementById('results').style.display = 'block';
            document.getElementById('productCount').textContent = products.length;
            document.getElementById('totalQty').textContent = products.reduce((s, p) => s + p.quantity, 0);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>åº${p.seq}</td>
                    <td>${p.name || '<span style="color:#94a3b8;">(ç©º)</span>'}</td>
                    <td>${p.spec || '<span style="color:#94a3b8;">(ç©º)</span>'}</td>
                    <td><strong>${p.quantity}</strong></td>
                </tr>
            `).join('');

            document.getElementById('debug').textContent = JSON.stringify(products.slice(0, 10), null, 2);
        }
    </script>
</body>

</html>