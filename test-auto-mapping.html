<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•æ˜ å°„æ¸¬è©¦å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #1e293b;
            color: #f1f5f9;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            color: #8b5cf6;
            margin-bottom: 20px;
        }

        .upload-section {
            background: #334155;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-box {
            display: inline-block;
            background: #475569;
            padding: 20px 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px dashed #64748b;
            margin: 10px;
        }

        .upload-box:hover {
            border-color: #8b5cf6;
        }

        input[type="file"] {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #334155;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #8b5cf6;
        }

        .stat-label {
            color: #94a3b8;
            margin-top: 5px;
        }

        .results {
            background: #334155;
            padding: 20px;
            border-radius: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #475569;
            font-size: 0.9em;
        }

        th {
            background: #475569;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #2d3748;
        }

        .correct {
            background: #10b98120;
        }

        .incorrect {
            background: #ef444420;
        }

        .confidence-high {
            color: #10b981;
            font-weight: 600;
        }

        .confidence-medium {
            color: #f59e0b;
        }

        .confidence-low {
            color: #ef4444;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¤– è‡ªå‹•æ˜ å°„æº–ç¢ºåº¦æ¸¬è©¦å·¥å…·</h1>

        <div class="upload-section">
            <h3 style="margin-bottom: 15px;">ä¸Šå‚³æª”æ¡ˆæ¸¬è©¦è‡ªå‹•æ˜ å°„</h3>
            <div class="upload-box" onclick="document.getElementById('pickingInput').click()">
                <div>ğŸ“¦ ä¸Šå‚³æ’¿è²¨å–®</div>
                <small style="color: #94a3b8;">MOMO/å®˜ç¶² Excel æˆ– è¦çš® PDF</small>
                <input type="file" id="pickingInput" accept=".xlsx,.pdf">
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">ç¸½å•†å“æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="mappedCount">0</div>
                <div class="stat-label">æˆåŠŸæ˜ å°„</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="highConfidence">0</div>
                <div class="stat-label">é«˜ä¿¡å¿ƒåº¦</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lowConfidence">0</div>
                <div class="stat-label">éœ€äººå·¥ç¢ºèª</div>
            </div>
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>ğŸ“Š è‡ªå‹•æ˜ å°„çµæœ</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 25%;">æ’¿è²¨å–®å•†å“</th>
                            <th style="width: 12%;">æ’¿è²¨å–®è¦æ ¼</th>
                            <th style="width: 5%;">æ•¸é‡</th>
                            <th style="width: 18%;">â†’ å ±è¡¨å•†å“</th>
                            <th style="width: 6%;">æ¬„ä½</th>
                            <th style="width: 10%;">è¦æ ¼</th>
                            <th style="width: 6%;">å°æ‡‰æ•¸é‡</th>
                            <th style="width: 8%;">ä¿¡å¿ƒåº¦</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pickingProducts = [];
        let mappingResults = [];

        document.getElementById('pickingInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // è­˜åˆ¥å¹³å°ä¾†æº
            let platform = 'unknown';
            const fileName = file.name.toLowerCase();
            if (file.name.endsWith('.pdf')) {
                platform = 'shopee';  // PDF éƒ½æ˜¯è¦çš®
                pickingProducts = await parseShopeePDF(file);
            } else {
                // Excel æª”æ¡ˆ
                if (fileName.includes('momo') || fileName.includes('å¯Œé‚¦')) {
                    platform = 'momo';
                } else if (fileName.includes('å®˜ç¶²')) {
                    platform = 'official';
                } else {
                    // å˜—è©¦å¾å…§å®¹åˆ¤æ–·
                    platform = 'momo';  // é è¨­ç‚º MOMO
                }
                pickingProducts = await parseExcel(file, platform);
            }

            // åŸ·è¡Œè‡ªå‹•æ˜ å°„ï¼ˆå‚³éå¹³å°åƒæ•¸ï¼‰
            mappingResults = pickingProducts.map(p => {
                const mapping = autoMapProduct(p.name, p.spec, p.quantity, platform);
                return {
                    ...p,
                    platform: platform,
                    ...mapping
                };
            });

            displayResults();
            e.target.value = '';
        });

        // æ ‡å‡†æŠ¥è¡¨å•†å“åç§°åˆ—è¡¨ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰
        const standardProductNames = [
            // å¡”é¡
            'è±†å¡”-è”“è¶Šè“', 'è±†å¡”-ç„¦ç³–', 'è±†å¡”-å·§å…‹åŠ›', 'è±†å¡”-æŠ¹èŒ¶', 'è±†å¡”-æ¤’éº»',
            'å …æœå¡”-èœ‚èœœ', 'å …æœå¡”-ç„¦ç³–', 'å …æœå¡”-å·§å…‹åŠ›', 'å …æœå¡”-æµ·è‹”', 'å …æœå¡”-å’–å“©',
            'è±†å¡”-ç¶œåˆ', 'å …æœå¡”-ç¶œåˆ', 'é›™å¡”',
            // é³³æ¢¨é…¥
            'åœŸé³³æ¢¨é…¥(ç´…é»)', 'é³³å‡°é…¥',
            // é›ªèŠ±é¤…
            'é›ªèŠ±é¤…-ç¶œåˆ', 'é›ªèŠ±é¤…-è”“è¶Šè“', 'é›ªèŠ±é¤…-å·§å…‹åŠ›', 'é›ªèŠ±é¤…-é‡‘æ²™', 'é›ªèŠ±é¤…-æŠ¹èŒ¶', 'é›ªèŠ±é¤…-è‚‰é¬†',
            // ç‘ªå¾·è“®
            'ç‘ªå¾·è“®-ç¶œåˆ', 'ç‘ªå¾·è“®-èœ‚èœœ', 'ç‘ªå¾·è“®-å·§å…‹åŠ›', 'ç‘ªå¾·è“®-ç´…èŒ¶', 'ç‘ªå¾·è“®-æŠ¹èŒ¶', 'ç‘ªå¾·è“®-æŸ‘æ©˜', 'ç‘ªå¾·è“®-æª¸æª¬',
            // ç„¡èª¿å‘³å …æœ
            'ç„¡èª¿å‘³ç¶œåˆå …æœ', 'ç„¡èª¿å‘³å¤å¨å¤·è±†', 'ç„¡èª¿å‘³è…°æœ', 'ç„¡èª¿å‘³æä»', 'ç„¡èª¿å‘³æ ¸æ¡ƒ',
            // æ¤°æ£—
            'â˜…ä¸­æ±æ¤°æ£—300g', 'æ¤°æ£—è±†å­150g', 'æ¤°æ£—è…°æœ150g', 'æ¤°æ£—æä»150g', 'æ¤°æ£—æ ¸æ¡ƒ150g',
            // å…¶ä»–
            'ç‰›å¥¶ç³–', 'å—æ£—æ ¸æ¡ƒç³•', 'ç‰›å¥¶ç³–-50g',
            // ç“¦ç‰‡
            'ç“¦ç‰‡-ç¶œåˆ', 'ç“¦ç‰‡-åŸå‘³', 'ç“¦ç‰‡-ç´…èŒ¶', 'ç“¦ç‰‡-å·§å…‹åŠ›', 'ç“¦ç‰‡-æµ·è‹”', 'ç“¦ç‰‡-æŠ¹èŒ¶', 'ç“¦ç‰‡-é»‘ç³–', 'ç“¦ç‰‡-é’èŠ±æ¤’', 'ç“¦ç‰‡-åŸå‘³45å…‹',
            // å¥¶æ²¹
            'å¥¶æ²¹-ç„¦ç³–ç‰›å¥¶', 'å¥¶æ²¹-æ³•åœ‹å·§å…‹åŠ›', 'å¥¶æ²¹-èœ‚èœœæª¸æª¬', 'å¥¶æ²¹-ä¼¯çˆµç´…èŒ¶', 'å¥¶æ²¹-æŠ¹èŒ¶',
            // è¥¿é»
            'åƒå±¤å°é…¥æ¢-åŸå‘³', 'è¥¿é»-ç¶œåˆ', 'è¥¿é»-å·§å…‹åŠ›è²æ®¼', 'è¥¿é»-å’–å•¡å°èŠ±', 'è¥¿é»-è—è“å°èŠ±', 'è¥¿é»-è”“è¶Šè“è²æ®¼', 'è¥¿é»-ä¹³é…ªé…¥æ¢',
            // ç¦®ç›’ï¼ˆæ”¾åœ¨æœ€å¾Œï¼Œç¢ºä¿å„ªå…ˆåŒ¹é…æ›´å…·é«”çš„ç¦®ç›’åç¨±ï¼‰
            'é›™å¡”ç¦®ç›’', 'è”“è¶Šè“ç¦®ç›’', 'ç¶œè±†ç¦®ç›’', 'ç¶œå …ç¦®ç›’', 'æ™´ç©ºå¡”é¤…ç¦®ç›’', 'æš–æš–å¹¸ç¦ç¦®ç›’', 'è‡»æ„›æ™‚å…‰ç¦®ç›’', 'æ¿ƒæƒ…æ»¿è¼‰ç¦®ç›’',
            'æµªæ¼«è©©ç¯‡ç¦®ç›’', 'æˆ€æˆ€é›ªèŠ±ç¦®ç›’', 'åˆå¾Œæ¼«æ­¥ç¦®ç›’', 'é‚£å¹´èŠ±é–‹ç¦®ç›’', 'èŠ±é–“é€¸éŸ»ç¦®ç›’',
            'è¼•-é¦™æ¦­æ¼«éŠç¦®ç›’', 'è¼•-æ™¨æ›¦ç‰©èªç¦®ç›’', 'è¼•-é‡‘ç·»å…¸è—ç¦®ç›’', 'è¼•-æœˆå…‰åºæ›²ç¦®ç›’'
        ];

        // æ ‡å‡†åŒ–å•†å“åç§°ï¼ˆåŒ¹é…åˆ°æ ‡å‡†åˆ—è¡¨ï¼‰
        function normalizeProductName(name) {
            if (!name) return null;

            // æ¸…ç†ç©ºæ ¼
            const cleaned = name.replace(/\s+/g, '');

            // 1. é¦–å…ˆå˜—è©¦ç²¾ç¢ºåŒ¹é…
            for (let stdName of standardProductNames) {
                const stdCleaned = stdName.replace(/\s+/g, '');
                if (cleaned === stdCleaned) {
                    return stdName;
                }
            }

            // 2. å˜—è©¦æ‰¾åˆ°æœ€ä½³åŒ¹é…ï¼ˆæœ€é•·çš„åŒ¹é…ï¼‰
            let bestMatch = null;
            let bestMatchLength = 0;

            for (let stdName of standardProductNames) {
                const stdCleaned = stdName.replace(/\s+/g, '');
                // æ£€æŸ¥æ ‡å‡†åç§°æ˜¯å¦åŒ…å«åœ¨è¾“å…¥ä¸­ï¼Œæˆ–è¾“å…¥æ˜¯å¦åŒ…å«æ ‡å‡†åç§°
                if (cleaned.includes(stdCleaned) && stdCleaned.length > bestMatchLength) {
                    bestMatch = stdName;
                    bestMatchLength = stdCleaned.length;
                }
            }

            if (bestMatch) {
                return bestMatch;
            }

            // 3. å¦‚æœè¿˜æ˜¯æ²¡æœ‰åŒ¹é…ï¼Œè¿”å›åŸåç§°
            return name;
        }

        // MOMO å°ˆç”¨æ˜ å°„å‡½æ•¸
        function autoMapProductMomo(pickingName, pickingSpec, quantity) {
            const fullText = `${pickingName} ${pickingSpec}`;
            const fullTextNoSpace = fullText.replace(/\s+/g, '');
            const nameNoSpace = pickingName.replace(/\s+/g, '');
            const specNoSpace = (pickingSpec || '').replace(/\s+/g, '');

            // éæ¿¾ï¼ˆç¦®ç›’ä¸æ‡‰è¢«éæ¿¾ï¼‰
            const isGiftBox = /ç¦®ç›’/.test(fullTextNoSpace);
            if (/å’–å•¡/.test(fullTextNoSpace) && !/å’–å•¡å°èŠ±/.test(fullTextNoSpace) && !isGiftBox) {
                return { templateProduct: null, templateColumn: null, templateSpec: null, multiplier: 1, mappedQuantity: 0, confidence: 0 };
            }
            // åªéæ¿¾ã€Œæè¢‹åŠ è³¼ã€ï¼Œä¸éæ¿¾ã€Œé™„æè¢‹ã€
            if (/æè¢‹åŠ è³¼/.test(fullTextNoSpace) || /é‹è²»/.test(fullTextNoSpace)) {
                return { templateProduct: null, templateColumn: null, templateSpec: null, multiplier: 1, mappedQuantity: 0, confidence: 0 };
            }

            let productName = null;
            let column = null;
            let spec = null;
            let multiplier = 1;
            let confidence = 0.3;

            // MOMO å•†å“åç¨±æ ¼å¼ï¼šé€šå¸¸åœ¨ã€Œå•†å“åç¨±ã€æ¬„ä½æœ‰å®Œæ•´è³‡è¨Š
            // ä¾‹å¦‚ï¼šã€Œå¤å¨å¤·è±†å¡”-èœ‚èœœè”“è¶Šè“å£å‘³ 90g(è¢‹è£)ã€

            // æå–å€æ•¸ï¼ˆå¦‚ x3åŒ… æˆ– 2ç›’ï¼‰
            const multiplierMatchPack = fullText.match(/x(\d+)åŒ…/);
            const multiplierMatchBox = specNoSpace.match(/^(\d+)ç›’/);
            if (multiplierMatchPack) {
                multiplier = parseInt(multiplierMatchPack[1]);
            } else if (multiplierMatchBox) {
                multiplier = parseInt(multiplierMatchBox[1]);
            }

            // === ç¦®ç›’é¡å‹ ===
            if (/ç¦®ç›’/.test(fullTextNoSpace)) {
                column = 'B'; spec = 'ç¦®ç›’'; confidence = 0.95;
                if (/é›™å¡”ç¦®ç›’/.test(fullTextNoSpace) || /æ‹›ç‰Œé›™å¡”/.test(fullTextNoSpace)) {
                    productName = 'é›™å¡”ç¦®ç›’';
                } else if (/å¤å¨å¤·è±†å¡”ç¦®ç›’/.test(fullTextNoSpace) && /è”“è¶Šè“/.test(fullTextNoSpace)) {
                    productName = 'è”“è¶Šè“ç¦®ç›’';
                } else if (/å¤å¨å¤·è±†å¡”ç¦®ç›’/.test(fullTextNoSpace) && /ç¶œåˆ/.test(fullTextNoSpace)) {
                    productName = 'ç¶œè±†ç¦®ç›’';
                } else if (/å …æœå¡”ç¦®ç›’/.test(fullTextNoSpace) && /ç¶œåˆ/.test(fullTextNoSpace)) {
                    productName = 'ç¶œå …ç¦®ç›’';
                } else if (/æˆ€æˆ€é›ªèŠ±ç¦®ç›’|æˆ€æˆ€é›ªèŠ±/.test(fullTextNoSpace)) {
                    productName = 'æˆ€æˆ€é›ªèŠ±ç¦®ç›’';
                } else if (/æµªæ¼«è©©ç¯‡ç¦®ç›’|æµªæ¼«è©©ç¯‡/.test(fullTextNoSpace)) {
                    productName = 'æµªæ¼«è©©ç¯‡ç¦®ç›’';
                } else if (/æš–æš–å¹¸ç¦ç¦®ç›’|æš–æš–å¹¸ç¦/.test(fullTextNoSpace)) {
                    productName = 'æš–æš–å¹¸ç¦ç¦®ç›’';
                } else if (/è‡»æ„›æ™‚å…‰ç¦®ç›’|è‡»æ„›æ™‚å…‰/.test(fullTextNoSpace)) {
                    productName = 'è‡»æ„›æ™‚å…‰ç¦®ç›’';
                } else if (/æ¿ƒæƒ…æ»¿è¼‰ç¦®ç›’|æ¿ƒæƒ…æ»¿è¼‰/.test(fullTextNoSpace)) {
                    productName = 'æ¿ƒæƒ…æ»¿è¼‰ç¦®ç›’';
                } else if (/åˆå¾Œæ¼«æ­¥ç¦®ç›’|åˆå¾Œæ¼«æ­¥/.test(fullTextNoSpace)) {
                    productName = 'åˆå¾Œæ¼«æ­¥ç¦®ç›’';
                } else if (/é‚£å¹´èŠ±é–‹ç¦®ç›’|é‚£å¹´èŠ±é–‹/.test(fullTextNoSpace)) {
                    productName = 'é‚£å¹´èŠ±é–‹ç¦®ç›’';
                } else if (/èŠ±é–“é€¸éŸ»ç¦®ç›’|èŠ±é–“é€¸éŸ»/.test(fullTextNoSpace)) {
                    productName = 'èŠ±é–“é€¸éŸ»ç¦®ç›’';
                } else if (/æ™´ç©ºå¡”é¤…ç¦®ç›’|æ™´ç©ºå¡”é¤…/.test(fullTextNoSpace)) {
                    productName = 'æ™´ç©ºå¡”é¤…ç¦®ç›’';
                } else if (/é‡‘ç·»å…¸è—ç¦®ç›’|é‡‘ç·»å…¸è—/.test(fullTextNoSpace)) {
                    productName = 'è¼•-é‡‘ç·»å…¸è—ç¦®ç›’';
                } else if (/é¦™æ¦­æ¼«éŠç¦®ç›’|é¦™æ¦­æ¼«éŠ/.test(fullTextNoSpace)) {
                    productName = 'è¼•-é¦™æ¦­æ¼«éŠç¦®ç›’';
                } else if (/æ™¨æ›¦ç‰©èªç¦®ç›’|æ™¨æ›¦ç‰©èª/.test(fullTextNoSpace)) {
                    productName = 'è¼•-æ™¨æ›¦ç‰©èªç¦®ç›’';
                } else if (/æœˆå…‰åºæ›²ç¦®ç›’|æœˆå…‰åºæ›²/.test(fullTextNoSpace)) {
                    productName = 'è¼•-æœˆå…‰åºæ›²ç¦®ç›’';
                } else if (/è”“è¶Šè“ç¦®ç›’/.test(fullTextNoSpace)) {
                    productName = 'è”“è¶Šè“ç¦®ç›’';
                } else if (/ç¶œè±†ç¦®ç›’/.test(fullTextNoSpace)) {
                    productName = 'ç¶œè±†ç¦®ç›’';
                } else if (/ç¶œå …ç¦®ç›’/.test(fullTextNoSpace)) {
                    productName = 'ç¶œå …ç¦®ç›’';
                }
            }

            // === è±†å¡” ===
            if (!productName && /å¤å¨å¤·è±†å¡”/.test(fullTextNoSpace)) {
                if (/èœ‚èœœè”“è¶Šè“|è”“è¶Šè“/.test(fullTextNoSpace)) productName = 'è±†å¡”-è”“è¶Šè“';
                else if (/ç„¦ç³–/.test(fullTextNoSpace)) productName = 'è±†å¡”-ç„¦ç³–';
                else if (/å·§å…‹åŠ›/.test(fullTextNoSpace)) productName = 'è±†å¡”-å·§å…‹åŠ›';
                else if (/æŠ¹èŒ¶/.test(fullTextNoSpace)) productName = 'è±†å¡”-æŠ¹èŒ¶';
                else if (/æ¤’éº»/.test(fullTextNoSpace)) productName = 'è±†å¡”-æ¤’éº»';
                else if (/ç¶œåˆ/.test(fullTextNoSpace)) productName = 'è±†å¡”-ç¶œåˆ';
            }

            // === å …æœå¡” ===
            if (!productName && /å …æœå¡”/.test(fullTextNoSpace)) {
                if (/èœ‚èœœ/.test(fullTextNoSpace)) productName = 'å …æœå¡”-èœ‚èœœ';
                else if (/ç„¦ç³–/.test(fullTextNoSpace)) productName = 'å …æœå¡”-ç„¦ç³–';
                else if (/å·§å…‹åŠ›/.test(fullTextNoSpace)) productName = 'å …æœå¡”-å·§å…‹åŠ›';
                else if (/æµ·è‹”/.test(fullTextNoSpace)) productName = 'å …æœå¡”-æµ·è‹”';
                else if (/å’–å“©/.test(fullTextNoSpace)) productName = 'å …æœå¡”-å’–å“©';
                else if (/ç¶œåˆ/.test(fullTextNoSpace)) productName = 'å …æœå¡”-ç¶œåˆ';
            }

            // === é›ªèŠ±é¤… ===
            if (!productName && /é›ªèŠ±é¤…/.test(fullTextNoSpace)) {
                if (/è”“è¶Šè“/.test(fullTextNoSpace)) productName = 'é›ªèŠ±é¤…-è”“è¶Šè“';
                else if (/å·§å…‹åŠ›/.test(fullTextNoSpace)) productName = 'é›ªèŠ±é¤…-å·§å…‹åŠ›';
                else if (/é‡‘æ²™/.test(fullTextNoSpace)) productName = 'é›ªèŠ±é¤…-é‡‘æ²™';
                else if (/æŠ¹èŒ¶/.test(fullTextNoSpace)) productName = 'é›ªèŠ±é¤…-æŠ¹èŒ¶';
                else if (/è‚‰é¬†/.test(fullTextNoSpace)) productName = 'é›ªèŠ±é¤…-è‚‰é¬†';
                else if (/ç¶œåˆ/.test(fullTextNoSpace)) productName = 'é›ªèŠ±é¤…-ç¶œåˆ';
            }

            // === ç‘ªå¾·è“® ===
            if (!productName && /ç‘ªå¾·è“®/.test(fullTextNoSpace)) {
                if (/æŠ¹èŒ¶/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-æŠ¹èŒ¶';
                else if (/æª¸æª¬/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-æª¸æª¬';
                else if (/ç´…èŒ¶/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-ç´…èŒ¶';
                else if (/èœ‚èœœ/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-èœ‚èœœ';
                else if (/å·§å…‹åŠ›/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-å·§å…‹åŠ›';
                else if (/æŸ‘æ©˜/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-æŸ‘æ©˜';
                else if (/ç¶œåˆ/.test(fullTextNoSpace)) productName = 'ç‘ªå¾·è“®-ç¶œåˆ';
            }

            // === ç“¦ç‰‡ ===
            if (!productName && /ç“¦ç‰‡|æä»ç“¦ç‰‡/.test(fullTextNoSpace)) {
                if (/åŸå‘³/.test(fullTextNoSpace) && /45g/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-åŸå‘³45å…‹';
                else if (/åŸå‘³/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-åŸå‘³';
                else if (/æŠ¹èŒ¶/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-æŠ¹èŒ¶';
                else if (/ç´…èŒ¶/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-ç´…èŒ¶';
                else if (/å·§å…‹åŠ›/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-å·§å…‹åŠ›';
                else if (/æµ·è‹”/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-æµ·è‹”';
                else if (/é»‘ç³–/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-é»‘ç³–';
                else if (/é’èŠ±æ¤’/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-é’èŠ±æ¤’';
                else if (/ç¶œåˆ/.test(fullTextNoSpace)) productName = 'ç“¦ç‰‡-ç¶œåˆ';
            }

            // === å¥¶æ²¹ ===
            if (!productName && /å¥¶æ²¹æ›²å¥‡|å¥¶æ²¹é¤…ä¹¾/.test(fullTextNoSpace)) {
                if (/æŠ¹èŒ¶|å°å±±åœ’æŠ¹èŒ¶/.test(fullTextNoSpace)) productName = 'å¥¶æ²¹-æŠ¹èŒ¶';
                else if (/ç„¦ç³–ç‰›å¥¶/.test(fullTextNoSpace)) productName = 'å¥¶æ²¹-ç„¦ç³–ç‰›å¥¶';
                else if (/æ³•åœ‹å·§å…‹åŠ›|å·§å…‹åŠ›/.test(fullTextNoSpace)) productName = 'å¥¶æ²¹-æ³•åœ‹å·§å…‹åŠ›';
                else if (/èœ‚èœœæª¸æª¬/.test(fullTextNoSpace)) productName = 'å¥¶æ²¹-èœ‚èœœæª¸æª¬';
                else if (/ä¼¯çˆµç´…èŒ¶/.test(fullTextNoSpace)) productName = 'å¥¶æ²¹-ä¼¯çˆµç´…èŒ¶';
            }

            // === è¥¿é» ===
            if (!productName && /è¥¿é»é¤…ä¹¾/.test(fullTextNoSpace)) {
                if (/ä¹³é…ªé…¥æ¢/.test(fullTextNoSpace)) productName = 'è¥¿é»-ä¹³é…ªé…¥æ¢';
                else if (/è”“è¶Šè“è²æ®¼/.test(fullTextNoSpace)) productName = 'è¥¿é»-è”“è¶Šè“è²æ®¼';
                else if (/è—è“å°èŠ±/.test(fullTextNoSpace)) productName = 'è¥¿é»-è—è“å°èŠ±';
                else if (/å’–å•¡å°èŠ±/.test(fullTextNoSpace)) productName = 'è¥¿é»-å’–å•¡å°èŠ±';
                else if (/å·§å…‹åŠ›è²æ®¼/.test(fullTextNoSpace)) productName = 'è¥¿é»-å·§å…‹åŠ›è²æ®¼';
                else if (/ç¶œåˆ/.test(fullTextNoSpace)) productName = 'è¥¿é»-ç¶œåˆ';
            }

            // === ç„¡èª¿å‘³å …æœ ===
            if (!productName && /ç„¡èª¿å‘³å …æœ/.test(fullTextNoSpace)) {
                // ç¶œåˆè¦æ”¾åœ¨æœ€å‰é¢ï¼Œå› ç‚ºç¶œåˆå•†å“å¯èƒ½åŒæ™‚åŒ…å«å¤šç¨®å …æœåç¨±
                if (/ç¶œåˆ|åŸå‘³ç¶œåˆ/.test(fullTextNoSpace)) productName = 'ç„¡èª¿å‘³ç¶œåˆå …æœ';
                else if (/æ ¸æ¡ƒ/.test(fullTextNoSpace)) productName = 'ç„¡èª¿å‘³æ ¸æ¡ƒ';
                else if (/è…°æœ/.test(fullTextNoSpace)) productName = 'ç„¡èª¿å‘³è…°æœ';
                else if (/æä»/.test(fullTextNoSpace)) productName = 'ç„¡èª¿å‘³æä»';
                else if (/å¤å¨å¤·è±†/.test(fullTextNoSpace)) productName = 'ç„¡èª¿å‘³å¤å¨å¤·è±†';
            }

            // === æ¤°æ£— ===
            if (!productName && /æ¤°æ£—/.test(fullTextNoSpace)) {
                if (/ä¸­æ±/.test(fullTextNoSpace)) productName = 'â˜…ä¸­æ±æ¤°æ£—300g';
                else if (/å¤å¨å¤·è±†/.test(fullTextNoSpace)) productName = 'æ¤°æ£—è±†å­150g';
                else if (/æ ¸æ¡ƒ/.test(fullTextNoSpace)) productName = 'æ¤°æ£—æ ¸æ¡ƒ150g';
                else if (/è…°æœ/.test(fullTextNoSpace)) productName = 'æ¤°æ£—è…°æœ150g';
                else if (/æä»/.test(fullTextNoSpace)) productName = 'æ¤°æ£—æä»150g';
            }

            // === ç‰›å¥¶ç³– ===
            if (!productName && /ç‰›å¥¶ç³–/.test(fullTextNoSpace)) {
                if (/50g/.test(fullTextNoSpace)) productName = 'ç‰›å¥¶ç³–-50g';
                else productName = 'ç‰›å¥¶ç³–';
            }

            // === åœŸé³³æ¢¨é…¥ ===
            if (!productName && /åœŸé³³æ¢¨é…¥|é‡‘ç£šåœŸé³³æ¢¨é…¥/.test(fullTextNoSpace)) {
                productName = 'åœŸé³³æ¢¨é…¥(ç´…é»)';
            }

            // === æ‹›ç‰Œé›™å¡”çµ„åˆ ===
            if (!productName && /æ‹›ç‰Œé›™å¡”çµ„åˆ|æ‹›ç‰Œé›™å¡”/.test(fullTextNoSpace)) {
                productName = 'é›™å¡”';
            }

            // === å—æ£—æ ¸æ¡ƒç³• ===
            if (!productName && /å—æ£—æ ¸æ¡ƒç³•/.test(fullTextNoSpace)) {
                productName = 'å—æ£—æ ¸æ¡ƒç³•';
            }

            // === é³³å‡°é…¥ ===
            if (!productName && /é³³å‡°é…¥/.test(fullTextNoSpace)) {
                productName = 'é³³å‡°é…¥';
            }

            // === è¦æ ¼æå– ===
            if (!column) {
                if (/300g/.test(fullTextNoSpace)) { column = 'B'; spec = '300g'; confidence = 0.9; }
                else if (/280g/.test(fullTextNoSpace)) { column = 'C'; spec = '280g'; confidence = 0.9; }
                else if (/200g/.test(fullTextNoSpace)) { column = 'C'; spec = '200g'; confidence = 0.9; }
                else if (/150g/.test(fullTextNoSpace)) { column = 'B'; spec = '150g'; confidence = 0.9; }
                else if (/135g/.test(fullTextNoSpace)) { column = 'C'; spec = '135g'; confidence = 0.9; }
                else if (/120g/.test(fullTextNoSpace)) { column = 'B'; spec = '120g'; confidence = 0.9; }
                else if (/90g/.test(fullTextNoSpace)) { column = 'B'; spec = '90g'; confidence = 0.9; }
                else if (/50g/.test(fullTextNoSpace) && !/150g/.test(fullTextNoSpace)) { column = 'B'; spec = '50g'; confidence = 0.9; }
                else if (/45g/.test(fullTextNoSpace)) { column = 'B'; spec = '45g'; confidence = 0.9; }
                else if (/15å…¥/.test(fullTextNoSpace)) { column = 'C'; spec = '15å…¥è¢‹è£'; confidence = 0.9; }
                else if (/12å…¥/.test(fullTextNoSpace)) { column = 'C'; spec = '12å…¥è¢‹è£'; confidence = 0.9; }
                else if (/10å…¥/.test(fullTextNoSpace)) { column = 'B'; spec = '10å…¥è¢‹è£'; confidence = 0.9; }
                else if (/8å…¥/.test(fullTextNoSpace)) { column = 'B'; spec = '8å…¥è¢‹è£'; confidence = 0.9; }
                // å–®é¡†/æ´»å‹•å°ˆç”¨
                else if (/å–®é¡†/.test(fullTextNoSpace) || /æ´»å‹•å°ˆç”¨/.test(fullTextNoSpace) || /æ´»å‹•/.test(fullTextNoSpace)) {
                    column = 'D'; spec = 'å–®é¡†'; confidence = 0.9;
                    // æå–Nå…¥ä½œç‚ºå€æ•¸
                    const activityMatch = specNoSpace.match(/(\d+)å…¥/);
                    if (activityMatch) {
                        multiplier = parseInt(activityMatch[1]);
                    }
                }
            }

            const mappedQuantity = column ? quantity * multiplier : 0;
            const standardizedName = productName ? normalizeProductName(productName) : null;

            return {
                templateProduct: standardizedName,
                templateColumn: column,
                templateSpec: spec,
                multiplier: multiplier,
                mappedQuantity: mappedQuantity,
                confidence: productName ? confidence : 0.3
            };
        }

        // è‡ªå‹•æ˜ å°„å‡½æ•¸ï¼ˆåŒ…è£å™¨ï¼Œæ ¹æ“šå¹³å°é¸æ“‡ï¼‰
        function autoMapProduct(pickingName, pickingSpec, quantity, platform = 'shopee') {
            // æ ¹æ“šå¹³å°é¸æ“‡ä¸åŒçš„æ˜ å°„å‡½æ•¸
            if (platform === 'momo' || platform === 'official') {
                return autoMapProductMomo(pickingName, pickingSpec, quantity);
            }
            // è¦çš®ä½¿ç”¨åŸä¾†çš„é‚è¼¯
            return autoMapProductShopee(pickingName, pickingSpec, quantity);
        }

        // è¦çš®å°ˆç”¨æ˜ å°„å‡½æ•¸ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        function autoMapProductShopee(pickingName, pickingSpec, quantity) {
            const fullText = `${pickingName} ${pickingSpec}`.toLowerCase();
            const fullTextNoSpaceTemp = `${pickingName} ${pickingSpec}`.replace(/\s+/g, '');

            // éæ¿¾ï¼ˆç¦®ç›’ä¸æ‡‰è¢«éæ¿¾ï¼‰
            const isGiftBox = /ç¦®ç›’/.test(fullTextNoSpaceTemp);
            if ((fullText.includes('å’–å•¡') && !fullText.includes('å’–å•¡å°èŠ±') && !isGiftBox) ||
                fullText.includes('æè¢‹åŠ è³¼')) {
                return {
                    templateProduct: null,
                    templateColumn: null,
                    templateSpec: null,
                    multiplier: 1,
                    mappedQuantity: 0,
                    confidence: 0
                };
            }

            // 1. ç§»é™¤å‰ç¶´
            let productName = pickingName.replace(/ã€è‰¾è–‡æ‰‹å·¥åŠã€‘/g, '').trim();

            // åˆä½µå•†å“åç¨±å’Œè¦æ ¼ï¼ˆä¿ç•™åŸå§‹å¤§å°å¯«ï¼Œç§»é™¤ç©ºæ ¼ç”¨æ–¼åŒ¹é…ï¼‰
            const fullTextNoSpace = `${pickingName} ${pickingSpec}`.replace(/\s+/g, '');
            const specNoSpace = pickingSpec.replace(/\s+/g, '');
            const nameNoSpace = productName.replace(/\s+/g, '');

            // 2. å„ªå…ˆå¾è¦æ ¼ä¸­æå–å£å‘³ï¼ˆçµ„åˆå•†å“ï¼‰
            let extractedFlavor = null;

            // === ç¦®ç›’é¡å‹åˆ¤æ–· ===
            if (/ç¦®ç›’/.test(fullTextNoSpace)) {
                if (/é›™å¡”ç¦®ç›’/.test(specNoSpace) || /é›™å¡”ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'é›™å¡”ç¦®ç›’';
                } else if (/æ‹›ç‰Œé›™å¡”/.test(fullTextNoSpace) && /ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'é›™å¡”ç¦®ç›’';
                } else if (/å¤å¨å¤·è±†å¡”ç¦®ç›’/.test(fullTextNoSpace) && /è”“è¶Šè“/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è”“è¶Šè“ç¦®ç›’';
                } else if (/å¤å¨å¤·è±†å¡”ç¦®ç›’/.test(fullTextNoSpace) && /ç¶œåˆ/.test(fullTextNoSpace)) {
                    extractedFlavor = 'ç¶œè±†ç¦®ç›’';
                } else if (/å …æœå¡”ç¦®ç›’/.test(fullTextNoSpace) && /ç¶œåˆ/.test(fullTextNoSpace)) {
                    extractedFlavor = 'ç¶œå …ç¦®ç›’';
                } else if (/æˆ€æˆ€é›ªèŠ±ç¦®ç›’|æ–°æˆ€æˆ€é›ªèŠ±/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æˆ€æˆ€é›ªèŠ±ç¦®ç›’';
                } else if (/æµªæ¼«è©©ç¯‡ç¦®ç›’|æ–°æµªæ¼«è©©ç¯‡/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æµªæ¼«è©©ç¯‡ç¦®ç›’';
                } else if (/æš–æš–å¹¸ç¦ç¦®ç›’|æ–°æš–æš–å¹¸ç¦/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æš–æš–å¹¸ç¦ç¦®ç›’';
                } else if (/è‡»æ„›æ™‚å…‰ç¦®ç›’|æ–°è‡»æ„›æ™‚å…‰/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è‡»æ„›æ™‚å…‰ç¦®ç›’';
                } else if (/æ¿ƒæƒ…æ»¿è¼‰ç¦®ç›’|æ–°æ¿ƒæƒ…æ»¿è¼‰/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æ¿ƒæƒ…æ»¿è¼‰ç¦®ç›’';
                } else if (/åˆå¾Œæ¼«æ­¥ç¦®ç›’|æ–°åˆå¾Œæ¼«æ­¥/.test(fullTextNoSpace)) {
                    extractedFlavor = 'åˆå¾Œæ¼«æ­¥ç¦®ç›’';
                } else if (/é‚£å¹´èŠ±é–‹ç¦®ç›’|æ–°é‚£å¹´èŠ±é–‹/.test(fullTextNoSpace)) {
                    extractedFlavor = 'é‚£å¹´èŠ±é–‹ç¦®ç›’';
                } else if (/èŠ±é–“é€¸éŸ»ç¦®ç›’|æ–°èŠ±é–“é€¸éŸ»/.test(fullTextNoSpace)) {
                    extractedFlavor = 'èŠ±é–“é€¸éŸ»ç¦®ç›’';
                } else if (/æ™´ç©ºå¡”é¤…ç¦®ç›’|æ–°æ™´ç©ºå¡”é¤…/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æ™´ç©ºå¡”é¤…ç¦®ç›’';
                } else if (/é‡‘ç·»å…¸è—ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è¼•-é‡‘ç·»å…¸è—ç¦®ç›’';
                } else if (/é¦™æ¦­æ¼«éŠç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è¼•-é¦™æ¦­æ¼«éŠç¦®ç›’';
                } else if (/æ™¨æ›¦ç‰©èªç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è¼•-æ™¨æ›¦ç‰©èªç¦®ç›’';
                } else if (/æœˆå…‰åºæ›²ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è¼•-æœˆå…‰åºæ›²ç¦®ç›’';
                } else if (/è”“è¶Šè“ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'è”“è¶Šè“ç¦®ç›’';
                } else if (/ç¶œè±†ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'ç¶œè±†ç¦®ç›’';
                } else if (/ç¶œå …ç¦®ç›’/.test(fullTextNoSpace)) {
                    extractedFlavor = 'ç¶œå …ç¦®ç›’';
                }
            }

            // === ç‘ªå¾·è“®å£å‘³ï¼ˆå¾è¦æ ¼æå–ï¼‰===
            if (!extractedFlavor && /ç‘ªå¾·è“®/.test(specNoSpace)) {
                if (/æŠ¹èŒ¶/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-æŠ¹èŒ¶';
                } else if (/æª¸æª¬/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-æª¸æª¬';
                } else if (/ç´…èŒ¶/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-ç´…èŒ¶';
                } else if (/èœ‚èœœ/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-èœ‚èœœ';
                } else if (/å·§å…‹åŠ›/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-å·§å…‹åŠ›';
                } else if (/æŸ‘æ©˜/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-æŸ‘æ©˜';
                } else if (/ç¶œåˆ|éš¨æ©Ÿ/.test(specNoSpace)) {
                    extractedFlavor = 'ç‘ªå¾·è“®-ç¶œåˆ';
                }
            }

            // === æä»ç“¦ç‰‡å£å‘³ï¼ˆå¾è¦æ ¼æå–ï¼‰===
            if (!extractedFlavor && /æä»ç“¦ç‰‡/.test(specNoSpace)) {
                if (/åŸå‘³/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-åŸå‘³';
                } else if (/æŠ¹èŒ¶/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-æŠ¹èŒ¶';
                } else if (/ç´…èŒ¶/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-ç´…èŒ¶';
                } else if (/å·§å…‹åŠ›/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-å·§å…‹åŠ›';
                } else if (/æµ·è‹”/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-æµ·è‹”';
                } else if (/é»‘ç³–/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-é»‘ç³–';
                } else if (/é’èŠ±æ¤’/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-é’èŠ±æ¤’';
                } else if (/ç¶œåˆ/.test(specNoSpace)) {
                    extractedFlavor = 'ç“¦ç‰‡-ç¶œåˆ';
                }
            }

            // === 50gç‰›å¥¶ç³– ===
            if (!extractedFlavor && fullTextNoSpace.includes('ç‰›å¥¶ç³–') && fullTextNoSpace.includes('50g')) {
                extractedFlavor = 'ç‰›å¥¶ç³–-50g';
            } else if (!extractedFlavor && fullTextNoSpace.includes('å¤å¨å¤·è±†æ³•å¼ç‰›å¥¶ç³–') && !fullTextNoSpace.includes('50g')) {
                extractedFlavor = 'ç‰›å¥¶ç³–';
            }

            // === ç„¡èª¿å‘³å …æœ ===
            if (!extractedFlavor && /ç„¡èª¿å‘³å …æœ/.test(fullTextNoSpace)) {
                if (/åŸå‘³æ ¸æ¡ƒ|æ ¸æ¡ƒ/.test(fullTextNoSpace) && !fullTextNoSpace.includes('ç¶œåˆ')) {
                    extractedFlavor = 'ç„¡èª¿å‘³æ ¸æ¡ƒ';
                } else if (/åŸå‘³è…°æœ|è…°æœ/.test(fullTextNoSpace) && !fullTextNoSpace.includes('ç¶œåˆ')) {
                    extractedFlavor = 'ç„¡èª¿å‘³è…°æœ';
                } else if (/åŸå‘³æä»|æä»/.test(fullTextNoSpace) && !fullTextNoSpace.includes('ç¶œåˆ')) {
                    extractedFlavor = 'ç„¡èª¿å‘³æä»';
                } else if (/å¤å¨å¤·è±†/.test(fullTextNoSpace)) {
                    extractedFlavor = 'ç„¡èª¿å‘³å¤å¨å¤·è±†';
                } else if (/ç¶œåˆ/.test(fullTextNoSpace) || /åŸå‘³ç¶œåˆ/.test(fullTextNoSpace)) {
                    extractedFlavor = 'ç„¡èª¿å‘³ç¶œåˆå …æœ';
                }
            }

            // === åœŸé³³æ¢¨é…¥ ===
            if (!extractedFlavor && /é‡‘ç£šåœŸé³³æ¢¨é…¥/.test(fullTextNoSpace)) {
                extractedFlavor = 'åœŸé³³æ¢¨é…¥(ç´…é»)';
            }

            // === æ¤°æ£—ç³»åˆ— ===
            if (!extractedFlavor && /æ¤°æ£—/.test(fullTextNoSpace)) {
                if (/æ¤°æ£—å¤å¨å¤·è±†/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æ¤°æ£—è±†å­150g';
                } else if (/æ¤°æ£—æ ¸æ¡ƒ/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æ¤°æ£—æ ¸æ¡ƒ150g';
                } else if (/æ¤°æ£—è…°æœ/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æ¤°æ£—è…°æœ150g';
                } else if (/æ¤°æ£—æä»/.test(fullTextNoSpace)) {
                    extractedFlavor = 'æ¤°æ£—æä»150g';
                } else if (/ä¸­æ±.*æ¤°æ£—|ä¸­æ±æ¤°æ£—/.test(fullTextNoSpace)) {
                    extractedFlavor = 'â˜…ä¸­æ±æ¤°æ£—300g';
                }
            }

            // === æä»ç“¦ç‰‡-åŸå‘³45g ç‰¹æ®Šè™•ç† ===
            if (!extractedFlavor && /æä»ç“¦ç‰‡/.test(fullTextNoSpace) && /åŸå‘³/.test(fullTextNoSpace) && /45g/.test(fullTextNoSpace)) {
                extractedFlavor = 'ç“¦ç‰‡-åŸå‘³45å…‹';
            }

            // === è¥¿é»é¤…ä¹¾ï¼ˆå„ªå…ˆå¾è¦æ ¼æå–ï¼‰===
            if (!extractedFlavor && (/è¥¿é»é¤…ä¹¾/.test(specNoSpace) || /è¥¿é»é¤…ä¹¾/.test(nameNoSpace))) {
                if (/ç¶œåˆè¥¿é»|ç¶œåˆ/.test(specNoSpace) || /ç¶œåˆè¥¿é»/.test(nameNoSpace)) {
                    extractedFlavor = 'è¥¿é»-ç¶œåˆ';
                } else if (/ä¹³é…ªé…¥æ¢/.test(specNoSpace)) {
                    extractedFlavor = 'è¥¿é»-ä¹³é…ªé…¥æ¢';
                } else if (/è”“è¶Šè“è²æ®¼/.test(specNoSpace)) {
                    extractedFlavor = 'è¥¿é»-è”“è¶Šè“è²æ®¼';
                } else if (/è—è“å°èŠ±/.test(specNoSpace)) {
                    extractedFlavor = 'è¥¿é»-è—è“å°èŠ±';
                } else if (/å’–å•¡å°èŠ±/.test(specNoSpace)) {
                    extractedFlavor = 'è¥¿é»-å’–å•¡å°èŠ±';
                } else if (/å·§å…‹åŠ›è²æ®¼/.test(specNoSpace)) {
                    extractedFlavor = 'è¥¿é»-å·§å…‹åŠ›è²æ®¼';
                }
            }

            // === å¾å•†å“åç¨±æå–å¤å¨å¤·è±†å¡”å£å‘³ï¼ˆæ´»å‹•å°ˆç”¨å–®é¡†ï¼‰===
            if (!extractedFlavor && /å¤å¨å¤·è±†å¡”/.test(nameNoSpace)) {
                if (/èœ‚èœœè”“è¶Šè“|è”“è¶Šè“/.test(nameNoSpace)) {
                    extractedFlavor = 'è±†å¡”-è”“è¶Šè“';
                } else if (/ç„¦ç³–/.test(nameNoSpace)) {
                    extractedFlavor = 'è±†å¡”-ç„¦ç³–';
                } else if (/å·§å…‹åŠ›/.test(nameNoSpace)) {
                    extractedFlavor = 'è±†å¡”-å·§å…‹åŠ›';
                } else if (/æŠ¹èŒ¶/.test(nameNoSpace)) {
                    extractedFlavor = 'è±†å¡”-æŠ¹èŒ¶';
                } else if (/æ¤’éº»/.test(nameNoSpace)) {
                    extractedFlavor = 'è±†å¡”-æ¤’éº»';
                } else if (/ç¶œåˆ/.test(nameNoSpace)) {
                    extractedFlavor = 'è±†å¡”-ç¶œåˆ';
                }
            }

            // === å¾å•†å“åç¨±æå–å¥¶æ²¹é¤…ä¹¾å£å‘³ ===
            if (!extractedFlavor && /å¥¶æ²¹æ›²å¥‡é¤…ä¹¾|å¥¶æ²¹é¤…ä¹¾/.test(nameNoSpace)) {
                if (/æŠ¹èŒ¶|å°å±±åœ’æŠ¹èŒ¶/.test(fullTextNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-æŠ¹èŒ¶';
                } else if (/ç„¦ç³–ç‰›å¥¶/.test(fullTextNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-ç„¦ç³–ç‰›å¥¶';
                } else if (/æ³•åœ‹å·§å…‹åŠ›|å·§å…‹åŠ›/.test(fullTextNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-æ³•åœ‹å·§å…‹åŠ›';
                } else if (/èœ‚èœœæª¸æª¬/.test(fullTextNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-èœ‚èœœæª¸æª¬';
                } else if (/ä¼¯çˆµç´…èŒ¶/.test(fullTextNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-ä¼¯çˆµç´…èŒ¶';
                }
            }

            // === å¾è¦æ ¼ä¹Ÿæå–å¥¶æ²¹é¤…ä¹¾å£å‘³ ===
            if (!extractedFlavor && /å¥¶æ²¹é¤…ä¹¾/.test(specNoSpace)) {
                if (/æŠ¹èŒ¶|å°å±±åœ’æŠ¹èŒ¶/.test(specNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-æŠ¹èŒ¶';
                } else if (/ç„¦ç³–ç‰›å¥¶/.test(specNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-ç„¦ç³–ç‰›å¥¶';
                } else if (/æ³•åœ‹å·§å…‹åŠ›|å·§å…‹åŠ›/.test(specNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-æ³•åœ‹å·§å…‹åŠ›';
                } else if (/èœ‚èœœæª¸æª¬/.test(specNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-èœ‚èœœæª¸æª¬';
                } else if (/ä¼¯çˆµç´…èŒ¶/.test(specNoSpace)) {
                    extractedFlavor = 'å¥¶æ²¹-ä¼¯çˆµç´…èŒ¶';
                }
            }

            // === å¾è¦æ ¼æå–å …æœå¡”å£å‘³ ===
            if (!extractedFlavor) {
                const nutTartMatch = specNoSpace.match(/å …æœå¡”-?(.+?)å£å‘³/);
                if (nutTartMatch) {
                    extractedFlavor = `å …æœå¡”-${nutTartMatch[1]}`;
                }
            }

            // === å¾è¦æ ¼æå–å¤å¨å¤·è±†å¡”å£å‘³ ===
            if (!extractedFlavor) {
                const beanTartMatch = specNoSpace.match(/å¤å¨å¤·è±†å¡”-?(.+?)(\d+å…¥|å£å‘³)/);
                if (beanTartMatch) {
                    let flavor = beanTartMatch[1].replace(/èœ‚èœœè”“è¶Šè“/, 'è”“è¶Šè“');
                    extractedFlavor = `è±†å¡”-${flavor}`;
                }
            }

            // === å¾è¦æ ¼æå–å¥¶æ²¹æ›²å¥‡å£å‘³ ===
            if (!extractedFlavor) {
                const butterMatch = specNoSpace.match(/å¥¶æ²¹æ›²å¥‡-?(.+?)å£å‘³/);
                if (butterMatch) {
                    extractedFlavor = `å¥¶æ²¹-${butterMatch[1]}`;
                }
            }

            // === å¾è¦æ ¼æå–ç“¦ç‰‡å£å‘³ï¼ˆåŒ…æ‹¬ç°¡åŒ–æ ¼å¼å¦‚"æŠ¹èŒ¶å£å‘³"ï¼‰===
            if (!extractedFlavor) {
                const waferMatch = specNoSpace.match(/æä»ç“¦ç‰‡-?(.+?)å£å‘³/) ||
                    specNoSpace.match(/^(.+?)å£å‘³\d+g/);
                if (waferMatch) {
                    extractedFlavor = `ç“¦ç‰‡-${waferMatch[1]}`;
                }
            }

            // === å¾è¦æ ¼æå–é›ªèŠ±é¤…å£å‘³ ===
            if (!extractedFlavor) {
                const snowMatch = specNoSpace.match(/é›ªèŠ±é¤…-(.+?)å£å‘³/);
                if (snowMatch) {
                    extractedFlavor = `é›ªèŠ±é¤…-${snowMatch[1]}`;
                }
            }

            // å¦‚æœå¾è¦æ ¼æå–åˆ°äº†å£å‘³ï¼Œä½¿ç”¨å®ƒ
            if (extractedFlavor) {
                productName = extractedFlavor;
            } else {
                // ç°¡åŒ–ç”¢å“åç¨±ï¼ˆå¾å•†å“åç¨±æå–ï¼‰
                const simplifyRules = [
                    { pattern: /å¤å¨å¤·è±†å¡”[|-](.+?)å£å‘³/, replacement: 'è±†å¡”-$1' },
                    { pattern: /å¤å¨å¤·è±†å¡”[|-](.+?)\s/, replacement: 'è±†å¡”-$1' },
                    { pattern: /å¤å¨å¤·è±†å¡”[|-](.+?)$/, replacement: 'è±†å¡”-$1' },
                    { pattern: /å …æœå¡”[|-](.+?)å£å‘³/, replacement: 'å …æœå¡”-$1' },
                    { pattern: /ç¶“å…¸æä»ç“¦ç‰‡[|-](.+?)å£å‘³/, replacement: 'ç“¦ç‰‡-$1' },
                    { pattern: /æä»ç“¦ç‰‡[|-](.+?)å£å‘³/, replacement: 'ç“¦ç‰‡-$1' },
                    { pattern: /ç¶“å…¸æä»ç“¦ç‰‡[|-](.+?)\s/, replacement: 'ç“¦ç‰‡-$1' },
                    { pattern: /æä»ç“¦ç‰‡[|-](.+?)\s/, replacement: 'ç“¦ç‰‡-$1' },
                    { pattern: /å¥¶æ²¹æ›²å¥‡é¤…ä¹¾[|-](.+?)å£å‘³/, replacement: 'å¥¶æ²¹-$1' },
                    { pattern: /å¥¶æ²¹é¤…ä¹¾[|-](.+?)å£å‘³/, replacement: 'å¥¶æ²¹-$1' },
                    { pattern: /é›ªèŠ±é¤…[|-](.+?)å£å‘³/, replacement: 'é›ªèŠ±é¤…-$1' },
                    { pattern: /èƒ–è²æ®¼ç‘ªå¾·è“®[|-](.+?)å£å‘³/, replacement: 'ç‘ªå¾·è“®-$1' },
                    { pattern: /æ‹›ç‰Œé›™å¡”çµ„åˆ/, replacement: 'é›™å¡”' },
                ];

                for (let rule of simplifyRules) {
                    if (rule.pattern.test(productName)) {
                        productName = productName.replace(rule.pattern, rule.replacement).trim();
                        break;
                    }
                }
            }

            // æ¸…ç†å¤šé¤˜å­—å…ƒï¼ˆä¿ç•™å•†å“åç¨±ï¼Œç§»é™¤é‡é‡å’Œæ•¸é‡è³‡è¨Šï¼‰
            // åªæœ‰åœ¨æœªæˆåŠŸæå–å£å‘³æ™‚æ‰æ¸…ç†
            if (!extractedFlavor) {
                productName = productName
                    .replace(/\s+/g, ' ')
                    .replace(/\d+g\/\d+g.*$/i, '')
                    .replace(/\d+g.*$/i, '')
                    .replace(/\d+å…¥.*$/i, '')
                    .replace(/\(è¢‹è£\)$/i, '')
                    .replace(/\(ç›’è£.*?\)$/i, '')
                    .replace(/\/è¢‹è£.*$/i, '')
                    .trim();
            }

            // 4. æå–å€æ•¸ï¼ˆåªçœ‹ xNåŒ…ï¼Œä¸çœ‹Nå…¥ï¼‰
            let multiplier = 1;
            const multiplierMatch = pickingSpec.match(/x\s*(\d+)\s*åŒ…/);
            if (multiplierMatch) {
                const num = parseInt(multiplierMatch[1]);
                if (!isNaN(num) && num > 0) {
                    multiplier = num;
                }
            }

            // 5. æå–è¦æ ¼ä¸¦åˆ¤æ–·æ¬„ä½
            let column = null;
            let spec = null;
            let confidence = 0.3;

            // å„ªå…ˆæª¢æŸ¥ç¦®ç›’ï¼ˆç¦®ç›’éƒ½æ˜¯æ¬„ä½Bï¼‰
            if (/ç¦®ç›’/.test(fullText)) {
                column = 'B';
                spec = 'ç¦®ç›’';
                confidence = 0.95;
                multiplier = 1;
            }
            // å„ªå…ˆå¾ pickingSpec æå–é‡é‡ï¼ˆæ›´ç²¾ç¢ºï¼‰
            else if (/45g/.test(pickingSpec)) {
                column = 'B'; spec = '45g'; confidence = 0.95; multiplier = 1;
            } else if (/50g/.test(pickingSpec)) {
                column = 'B'; spec = '50g'; confidence = 0.95; multiplier = 1;
            } else if (/90g/.test(pickingSpec)) {
                column = 'B'; spec = '90g'; confidence = 0.95; multiplier = 1;
            } else if (/120g/.test(pickingSpec)) {
                column = 'B'; spec = '120g'; confidence = 0.95; multiplier = 1;
            } else if (/135g/.test(pickingSpec)) {
                column = 'C'; spec = '135g'; confidence = 0.95; multiplier = 1;
            } else if (/150g/.test(pickingSpec)) {
                column = 'B'; spec = '150g'; confidence = 0.95; multiplier = 1;
            } else if (/200g/.test(pickingSpec)) {
                column = 'C'; spec = '200g'; confidence = 0.95; multiplier = 1;
            } else if (/280g/.test(pickingSpec)) {
                column = 'C'; spec = '280g'; confidence = 0.95; multiplier = 1;
            } else if (/300g/.test(pickingSpec)) {
                column = 'B'; spec = '300g'; confidence = 0.95; multiplier = 1;
            }
            // å¾å•†å“åç¨±æå–é‡é‡ï¼ˆæ¬¡å„ªå…ˆç´šï¼Œå…ˆåŒ¹é…è¼ƒé•·çš„ï¼‰
            else if (/300g/.test(pickingName)) {
                column = 'B'; spec = '300g'; confidence = 0.9; multiplier = 1;
            } else if (/280g/.test(pickingName)) {
                column = 'C'; spec = '280g'; confidence = 0.9; multiplier = 1;
            } else if (/200g/.test(pickingName)) {
                column = 'C'; spec = '200g'; confidence = 0.9; multiplier = 1;
            } else if (/150g/.test(pickingName)) {
                column = 'B'; spec = '150g'; confidence = 0.9; multiplier = 1;
            } else if (/135g/.test(pickingName)) {
                column = 'C'; spec = '135g'; confidence = 0.9; multiplier = 1;
            } else if (/120g/.test(pickingName)) {
                column = 'B'; spec = '120g'; confidence = 0.9; multiplier = 1;
            } else if (/90g/.test(pickingName) && !/\//.test(pickingName)) {
                column = 'B'; spec = '90g'; confidence = 0.9; multiplier = 1;
            } else if (/(?<!\d)50g/.test(pickingName)) {
                column = 'B'; spec = '50g'; confidence = 0.9; multiplier = 1;
            } else if (/(?<!\d)45g/.test(pickingName)) {
                column = 'B'; spec = '45g'; confidence = 0.9; multiplier = 1;
            }
            // å¾è¦æ ¼æª¢æŸ¥æ•¸é‡ï¼ˆä½¿ç”¨ç„¡ç©ºæ ¼ç‰ˆæœ¬ï¼‰
            else if (/15å…¥/.test(specNoSpace)) {
                column = 'C'; spec = '15å…¥è¢‹è£'; confidence = 0.9;
            } else if (/12å…¥/.test(specNoSpace)) {
                column = 'C'; spec = '12å…¥è¢‹è£'; confidence = 0.9;
            } else if (/10å…¥/.test(specNoSpace)) {
                column = 'B'; spec = '10å…¥è¢‹è£'; confidence = 0.9;
            } else if (/8å…¥/.test(specNoSpace)) {
                column = 'B'; spec = '8å…¥è¢‹è£'; confidence = 0.9;
            }
            // å¾å•†å“åç¨±æª¢æŸ¥æ•¸é‡ï¼ˆæ¬¡å„ªå…ˆç´šï¼Œä½¿ç”¨ç„¡ç©ºæ ¼ç‰ˆæœ¬ï¼‰
            else if (/15å…¥/.test(nameNoSpace) && !/10å…¥/.test(specNoSpace)) {
                column = 'C'; spec = '15å…¥è¢‹è£'; confidence = 0.85;
            } else if (/12å…¥/.test(nameNoSpace) && !/\d+å…¥/.test(specNoSpace)) {
                column = 'C'; spec = '12å…¥è¢‹è£'; confidence = 0.85;
            } else if (/10å…¥/.test(nameNoSpace) && !/\d+å…¥/.test(specNoSpace)) {
                column = 'B'; spec = '10å…¥è¢‹è£'; confidence = 0.85;
            } else if (/8å…¥/.test(nameNoSpace) && !/\d+å…¥/.test(specNoSpace)) {
                column = 'B'; spec = '8å…¥è¢‹è£'; confidence = 0.85;
            }
            // æª¢æŸ¥å–®å€‹ï¼ˆå¦‚æœè¦æ ¼æœ‰Ninå‰‡ç‚ºå€æ•¸ï¼‰
            else if (/å–®é¡†/.test(fullText) || /å–®å€‹/.test(fullText)) {
                column = 'D'; spec = 'å–®é¡†'; confidence = 0.85;
                // æª¢æŸ¥æ˜¯å¦æœ‰2å…¥ã€3å…¥ç­‰
                const singleMatch = specNoSpace.match(/(\d+)å…¥/);
                if (singleMatch) {
                    multiplier = parseInt(singleMatch[1]);
                }
            } else if (/\d+å…¥/.test(specNoSpace) && /æ´»å‹•/.test(fullTextNoSpace)) {
                column = 'D'; spec = 'å–®é¡†'; confidence = 0.8;
                const activityMatch = specNoSpace.match(/(\d+)å…¥/);
                if (activityMatch) {
                    multiplier = parseInt(activityMatch[1]);
                }
            }

            // 6. è¨ˆç®—å°æ‡‰æ•¸é‡
            const mappedQuantity = column ? quantity * multiplier : 0;

            // 7. æ¨™æº–åŒ–å•†å“åç¨±ï¼ˆåŒ¹é…åˆ°æ¨™æº–åˆ—è¡¨ï¼‰
            const standardizedName = normalizeProductName(productName);

            return {
                templateProduct: standardizedName,
                templateColumn: column,
                templateSpec: spec,
                multiplier: multiplier,
                mappedQuantity: mappedQuantity,
                confidence: confidence
            };
        }

        async function parseExcel(file, platform = 'momo') {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];

            const isOfficial = platform === 'official';
            const data = XLSX.utils.sheet_to_json(worksheet, {
                range: isOfficial ? 6 : 0
            });

            return data.map(row => ({
                name: row['å•†å“åç¨±'] || '',
                spec: row['å–®å“è¦æ ¼'] || row['è¦æ ¼'] || '',
                quantity: parseInt(row['æ’¿è²¨æ•¸é‡'] || row['æ•¸é‡'] || 0)
            })).filter(p => p.name && p.quantity > 0 && !p.name.includes('é‹è²»'));
        }

        async function parseShopeePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            const allProducts = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageItems = textContent.items.map(item => ({
                    text: item.str.trim(),
                    x: Math.round(item.transform[4]),
                    y: Math.round(item.transform[5])
                }));

                const products = parseShopeePage(pageItems);
                allProducts.push(...products);
            }

            return allProducts;
        }

        function parseShopeePage(items) {
            const rows = groupByY(items);
            const columnRanges = {
                seq: { min: 32, max: 59 },
                productName: { min: 166, max: 307 },
                spec: { min: 308, max: 396 },
                quantity: { min: 397, max: 520 }
            };

            let headerY = null;
            for (let row of rows) {
                if (row.items.some(i => i.text.includes('å•†å“åç¨±'))) {
                    headerY = row.y;
                    break;
                }
            }

            if (!headerY) return [];

            const products = [];
            let currentProduct = null;

            rows.forEach(row => {
                if (row.y >= headerY) return;

                let seqNum = null;
                row.items.forEach(item => {
                    if (item.x >= columnRanges.seq.min && item.x <= columnRanges.seq.max) {
                        const num = parseInt(item.text.trim());
                        if (!isNaN(num) && num > 0) seqNum = num;
                    }
                });

                if (seqNum) {
                    if (currentProduct) products.push(currentProduct);
                    currentProduct = { seq: seqNum, name: [], spec: [], quantity: null };
                }

                if (currentProduct) {
                    const rowText = row.items.map(i => i.text).join(' ');
                    if (rowText.includes('åˆè¨ˆ')) return;

                    row.items.forEach(item => {
                        const x = item.x;
                        const t = item.text.trim();

                        if (x >= columnRanges.productName.min && x <= columnRanges.productName.max) {
                            if (!t.match(/^\d+$/)) currentProduct.name.push(t);
                        } else if (x >= columnRanges.spec.min && x <= columnRanges.spec.max) {
                            if (!t.match(/^\d+$/)) currentProduct.spec.push(t);
                        } else if (x >= columnRanges.quantity.min && x <= columnRanges.quantity.max) {
                            const num = parseInt(t);
                            if (!isNaN(num) && num > 0) currentProduct.quantity = num;
                        }
                    });
                }
            });

            if (currentProduct) products.push(currentProduct);

            return products.filter(p => p.seq && p.seq > 0).map(p => ({
                name: p.name.join(' '),
                spec: p.spec.join(' '),
                quantity: p.quantity || 0
            }));
        }

        function groupByY(items, tolerance = 5) {
            const sorted = [...items].sort((a, b) => b.y - a.y);
            const groups = [];
            sorted.forEach(item => {
                let found = false;
                for (let g of groups) {
                    if (Math.abs(g.y - item.y) <= tolerance) {
                        g.items.push(item);
                        found = true;
                        break;
                    }
                }
                if (!found) groups.push({ y: item.y, items: [item] });
            });
            groups.forEach(g => g.items.sort((a, b) => a.x - b.x));
            return groups;
        }

        function displayResults() {
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('results').style.display = 'block';

            const total = mappingResults.length;
            const mapped = mappingResults.filter(r => r.templateColumn).length;
            const highConf = mappingResults.filter(r => r.confidence >= 0.8).length;
            const lowConf = mappingResults.filter(r => r.confidence < 0.5).length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('mappedCount').textContent = mapped;
            document.getElementById('highConfidence').textContent = highConf;
            document.getElementById('lowConfidence').textContent = lowConf;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = mappingResults.map((r, i) => {
                const confClass = r.confidence >= 0.8 ? 'confidence-high' :
                    r.confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
                const confPercent = Math.round(r.confidence * 100);

                // é¡¯ç¤ºè¨ˆç®—å…¬å¼
                const quantityDisplay = r.multiplier > 1
                    ? `${r.quantity} Ã— ${r.multiplier}`
                    : r.quantity;

                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${r.name}</td>
                        <td style="color: #94a3b8;">${r.spec || '-'}</td>
                        <td><strong>${quantityDisplay}</strong></td>
                        <td style="color: #10b981;"><strong>${r.templateProduct || 'âŒ æœªè­˜åˆ¥'}</strong></td>
                        <td><strong>${r.templateColumn || '-'}</strong></td>
                        <td>${r.templateSpec || '-'}</td>
                        <td style="color: #8b5cf6;"><strong>${r.mappedQuantity || '-'}</strong></td>
                        <td class="${confClass}">${confPercent}%</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>

</html>